// Payment Service Database Schema - PostgreSQL Production
// This is a separate database from the main application

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("PAYMENT_DATABASE_URL")
}

// Wallet for each user (userId references User in main database)
model Wallet {
  id           String        @id @default(cuid())
  userId       String        @unique
  balance      Decimal       @default(0) @db.Decimal(10, 2)
  currency     String        @default("USD")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  transactions Transaction[]

  @@index([userId])
}

// All financial transactions
model Transaction {
  id             String            @id @default(cuid())
  walletId       String
  wallet         Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type           TransactionType
  amount         Decimal           @db.Decimal(10, 2)
  status         TransactionStatus @default(PENDING)
  description    String?
  metadata       Json?             // Structured data for Stripe IDs, etc

  createdAt      DateTime          @default(now())

  refundRequests RefundRequest[]

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  LEAD_UNLOCK
  REFUND
  ESCROW_HOLD
  ESCROW_RELEASE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// Escrow holds for booking deposits
model EscrowHold {
  id         String        @id @default(cuid())
  payerId    String        // Tenant user ID (references User in main db)
  payeeId    String        // Host user ID (references User in main db)
  bookingId  String        // References Booking in main db
  amount     Decimal       @db.Decimal(10, 2)
  status     EscrowStatus  @default(HELD)

  heldAt     DateTime      @default(now())
  releasedAt DateTime?

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([payerId])
  @@index([payeeId])
  @@index([bookingId])
  @@index([status])
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
  DISPUTED
}

// Refund requests for transactions
model RefundRequest {
  id            String       @id @default(cuid())
  transactionId String
  transaction   Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  requesterId   String       // User ID who requested refund
  amount        Decimal      @db.Decimal(10, 2)
  reason        String
  status        RefundStatus @default(PENDING)
  adminNote     String?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([transactionId])
  @@index([requesterId])
  @@index([status])
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
}
